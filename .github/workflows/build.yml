on:
  push:
  pull_request:
  workflow_dispatch:
jobs:
  build:
    name: Build and package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install toltecmk
        run: pip install toltecmk
      - name: Build package
        run: |
          tar -czvf src.tar.gz src
          toltecmk
      - name: Save packages
        uses: actions/upload-artifact@v3
        with:
          name: packages
          path: dist/rm*/*.ipk
      - name: Save repo
        uses: actions/upload-artifact@v3
        with:
          name: rmall
          path: dist/rmall
  test:
    name: Test package
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/download-artifact@v3
        id: download
        with:
          name: rmall
      - uses: Eeems-Org/run-in-remarkable-action@v1
        with:
          setup: |
            set -ex
            echo "src/gz local-rmall file:///opt/tmp/src" > /opt/etc/opkg.conf.d/16-local.conf
          run: |
            set -ex
            echo Y | toltecctl generate-opkg-conf
            opkg update
            opkg install my-app
            # Add steps here to test app
            opkg remove my-app
          path: ${{ steps.download.outputs.download-path }}
